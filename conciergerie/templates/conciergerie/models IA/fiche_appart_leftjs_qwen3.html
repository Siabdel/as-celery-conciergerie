
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fiche Bien - Conciergerie Pro</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@3.0.1/Control.FullScreen.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
  <!-- Ic√¥nes -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --color-primary: #FF6B35;
      --color-secondary: #005E9B;
      --color-light: #FFFFFF;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
    }
    .hero-header {
      background: linear-gradient(120deg, var(--color-secondary), #004a7a);
      color: white;
      padding: 2rem 0;
    }
    .property-card {
      border-left: 4px solid var(--color-primary);
      box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }
    .carousel-control {
      background: rgba(0,0,0,0.3);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      top: 50%;
      transform: translateY(-50%);
    }
    #map-container {
      height: 450px;
      border-radius: 8px;
      overflow: hidden;
    }
    .btn-primary {
      background-color: var(--color-primary);
      border-color: var(--color-primary);
    }
    .btn-secondary {
      background-color: var(--color-secondary);
      border-color: var(--color-secondary);
    }
    .feature-badge {
      background-color: rgba(255, 107, 53, 0.1);
      color: var(--color-primary);
    }
    .leaflet-popup-content {
      min-width: 200px;
    }
    .floor-marker {
      background: var(--color-primary);
      border: 2px solid white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .rating-stars {
      color: #ffc107;
    }
    .info-layer-control {
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }
    .itinerary-panel {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    footer a {
      color: var(--color-secondary);
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<div id="app">
  <!-- Header -->
  <header class="hero-header mb-4">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="h3 mb-2">{{ property.titre }}</h1>
          <p class="mb-1"><i class="bi bi-geo-alt me-2"></i> {{ property.adresse }}</p>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <span class="badge bg-light text-dark">{{ property.type }}</span>
            <span class="badge bg-light text-dark">{{ property.surface }} m¬≤</span>
            <span class="badge bg-light text-dark">{{ property.pieces }} pi√®ces</span>
          </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <div class="h4 mb-1">{{ property.prix }} ‚Ç¨</div>
          <button class="btn btn-light">üìÖ Visite</button>
        </div>
      </div>
    </div>
  </header>

  <main class="container mb-5">
    <div class="row g-4">
      <!-- Galerie Photos -->
      <div class="col-lg-7">
        <div class="card property-card">
          <div class="card-body">
            <div id="photoCarousel" class="carousel slide" data-bs-ride="carousel">
              <div class="carousel-inner">
                <div v-for="(photo, index) in property.photos" :key="index" 
                     class="carousel-item" :class="{ active: index === 0 }">
                  <img :src="photo.url" class="d-block w-100" 
                       style="height: 400px; object-fit: cover;" 
                       :alt="'Photo ' + (index+1)"
                       @click="openLightbox(index)">
                </div>
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#photoCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#photoCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
              </button>
            </div>
            <div class="d-flex justify-content-center mt-2">
              <div v-for="(photo, index) in property.photos" 
                   :key="index" 
                   class="mx-1" 
                   @click="setCurrentSlide(index)"
                   style="cursor: pointer;">
                <img :src="photo.thumb || photo.url" 
                     class="img-thumbnail" 
                     style="width: 60px; height: 40px; object-fit: cover;"
                     :class="{ 'border-primary border-2': index === currentSlide }">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- D√©tails du bien -->
      <div class="col-lg-5">
        <div class="card property-card h-100">
          <div class="card-body">
            <h3 class="card-title h5">D√©tails du bien</h3>
            <div class="row mb-3">
              <div class="col-sm-6 mb-2">
                <small class="text-muted">Propri√©taire</small>
                <div class="fw-medium">{{ property.owner.nom }}</div>
              </div>
              <div class="col-sm-6 mb-2">
                <small class="text-muted">T√©l√©phone</small>
                <div class="fw-medium">{{ property.owner.tel }}</div>
              </div>
              <div class="col-sm-6 mb-2">
                <small class="text-muted">√âtage</small>
                <div class="fw-medium">{{ property.etage }}</div>
              </div>
              <div class="col-sm-6 mb-2">
                <small class="text-muted">Charges</small>
                <div class="fw-medium">{{ property.charges }} ‚Ç¨/mois</div>
              </div>
            </div>

            <h4 class="h6 mt-3">Caract√©ristiques</h4>
            <div class="d-flex flex-wrap gap-1 mb-3">
              <span v-for="feature in property.caracteristiques" 
                    :key="feature" 
                    class="badge feature-badge">{{ feature }}</span>
            </div>

            <div class="mt-3">
              <h4 class="h6">Description</h4>
              <p class="small">{{ property.description }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Cartographie interactive -->
      <div class="col-12">
        <div class="card property-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h3 class="card-title h5 mb-0">Localisation & Services</h3>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-primary" @click="locateUser">
                  <i class="bi bi-geo-alt"></i> Ma position
                </button>
                <button class="btn btn-sm btn-outline-secondary" @click="toggleView">
                  {{ mapView ? "Plan d\'√©tage" : "Carte" }}
                </button>
              </div>
            </div>
            
            <!-- Itin√©raire -->
            <div v-if="showItinerary" class="itinerary-panel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="h6 mb-0">Itin√©raire vers le bien</h5>
                <button class="btn-close" @click="showItinerary = false"></button>
              </div>
              <div class="mb-2">
                <input v-model="departurePoint" type="text" class="form-control form-control-sm" placeholder="Point de d√©part">
              </div>
              <div class="d-grid">
                <button class="btn btn-sm btn-primary" @click="calculateRoute">
                  <i class="bi bi-sign-turn-right"></i> Calculer l'itin√©raire
                </button>
              </div>
            </div>
            
            <div v-if="!mapView" class="mb-3">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Cliquez sur les marqueurs pour voir les d√©tails des pi√®ces
              </div>
            </div>

            <div id="map-container"></div>
            
            <!-- Contr√¥les couches -->
            <div class="mt-3">
              <h4 class="h6">Couches d'information</h4>
              <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-sm" 
                        :class="layers.transport ? 'btn-success' : 'btn-outline-secondary'"
                        @click="toggleLayer('transport')">
                  <i class="bi bi-train-front me-1"></i> Transports
                </button>
                <button class="btn btn-sm" 
                        :class="layers.commerces ? 'btn-success' : 'btn-outline-secondary'"
                        @click="toggleLayer('commerces')">
                  <i class="bi bi-shop me-1"></i> Commerces
                </button>
                <button class="btn btn-sm" 
                        :class="layers.services ? 'btn-success' : 'btn-outline-secondary'"
                        @click="toggleLayer('services')">
                  <i class="bi bi-hospital me-1"></i> Services
                </button>
                <button class="btn btn-sm btn-outline-primary" @click="showItinerary = !showItinerary">
                  <i class="bi bi-sign-turn-right me-1"></i> Itin√©raire
                </button>
              </div>
            </div>
            
            <div v-if="!mapView" class="mt-3">
              <h4 class="h6">L√©gende des pi√®ces</h4>
              <div class="d-flex flex-wrap gap-2">
                <div v-for="room in property.plan" :key="room.id" class="d-flex align-items-center">
                  <div class="me-2" :style="{ 
                    width: '20px', 
                    height: '20px', 
                    backgroundColor: room.color 
                  }"></div>
                  <small>{{ room.nom }} ({{ room.surface }} m¬≤)</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Note des pi√®ces -->
      <div class="col-12">
        <div class="card property-card">
          <div class="card-body">
            <h3 class="card-title h5 mb-3">√âvaluation des pi√®ces</h3>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Pi√®ce</th>
                    <th>Surface</th>
                    <th>Note</th>
                    <th>Commentaire</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="room in property.plan" :key="room.id">
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="me-2" :style="{ 
                          width: '15px', 
                          height: '15px', 
                          backgroundColor: room.color 
                        }"></div>
                        {{ room.nom }}
                      </div>
                    </td>
                    <td>{{ room.surface }} m¬≤</td>
                    <td>
                      <div class="rating-stars">
                        <span v-for="star in 5" :key="star">
                          <i class="bi" :class="star <= room.rating ? 'bi-star-fill' : 'bi-star'"></i>
                        </span>
                        ({{ room.rating }}/5)
                      </div>
                    </td>
                    <td>
                      <small class="text-muted">{{ room.comment || 'Aucun commentaire' }}</small>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" @click="rateRoom(room)">
                        <i class="bi bi-pencil"></i> Noter
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- D√©tails immeuble -->
      <div class="col-12">
        <div class="card property-card">
          <div class="card-body">
            <h3 class="card-title h5 mb-3">Informations Immeuble</h3>
            <div class="row g-4">
              <div class="col-lg-6">
                <div class="d-flex align-items-start">
                  <i class="bi bi-building fs-4 text-primary me-3"></i>
                  <div>
                    <h4 class="h6 mb-1">{{ property.immeuble.nom }}</h4>
                    <p class="small mb-2">{{ property.immeuble.adresse }}</p>
                    <p class="small text-muted">
                      {{ property.immeuble.etages }} √©tages | 
                      {{ property.immeuble.appartements }} appartements | 
                      Ann√©e {{ property.immeuble.annee }}
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="d-flex align-items-start">
                  <i class="bi bi-people fs-4 text-primary me-3"></i>
                  <div>
                    <h4 class="h6 mb-1">Gestionnaire</h4>
                    <p class="small mb-1">{{ property.gestionnaire.nom }}</p>
                    <a :href="'tel:' + property.gestionnaire.tel" class="small text-decoration-none">
                      üìû {{ property.gestionnaire.tel }}
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal notation -->
  <div class="modal fade" id="ratingModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Noter la pi√®ce : {{ selectedRoom?.nom }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Note (1-5 √©toiles)</label>
            <div class="rating-stars text-center">
              <span v-for="star in 5" :key="star" @click="setRating(star)" style="cursor: pointer; font-size: 1.5rem;">
                <i class="bi" :class="star <= newRating ? 'bi-star-fill' : 'bi-star'"></i>
              </span>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Commentaire</label>
            <textarea v-model="newComment" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" @click="saveRating">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lightbox pour zoom photo -->
  <div class="modal fade" id="photoLightbox" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Vue agrandie</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <img :src="currentPhotoUrl" class="img-fluid" alt="Vue agrandie">
        </div>
      </div>
    </div>
  </div>

  <footer class="bg-light text-center py-4 border-top">
    <div class="container">
      <p class="mb-1">
        <a href="#">Mentions l√©gales</a> | 
        <a href="#">Contact</a> | 
        <a href="#">Support</a> | 
        <a href="#">CGV</a>
      </p>
      <p class="text-muted small mb-0">&copy; 2025 ConciergeriePro. Tous droits r√©serv√©s.</p>
    </div>
  </footer>
</div>

<!-- Vue.js 3 -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Leaflet JS + Plugins (charg√©s apr√®s les autres scripts) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.fullscreen@3.0.1/Control.FullScreen.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Attente que tous les scripts soient charg√©s
document.addEventListener('DOMContentLoaded', function() {
  // Plugins Leaflet
  (function() {
    // Fullscreen Control
    if (typeof L !== 'undefined' && L.Control) {
      L.Control.FullScreen = L.Control.extend({
        onAdd: function(map) {
          var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-fullscreen');
          container.innerHTML = '<a href="#" title="Plein √©cran"><i class="bi bi-arrows-fullscreen"></i></a>';
          container.onclick = function(e) {
            e.preventDefault();
            if (map.toggleFullscreen) {
              map.toggleFullscreen();
            }
          };
          return container;
        }
      });
      L.control.fullscreen = function(opts) {
        return new L.Control.FullScreen(opts);
      };
    }
  })();

  const { createApp, ref, computed, onMounted } = Vue;

  const app = createApp({
    setup() {
      const currentSlide = ref(0);
      const currentPhotoIndex = ref(0);
      const mapView = ref(true); // true = carte, false = plan d'√©tage
      const showItinerary = ref(false);
      const departurePoint = ref('');
      const selectedRoom = ref(null);
      const newRating = ref(0);
      const newComment = ref('');
      const map = ref(null);
      const markers = ref([]);
      const floorMarkers = ref([]);
      const infoLayers = ref({
        transport: [],
        commerces: [],
        services: []
      });
      const layers = ref({
        transport: false,
        commerces: false,
        services: false
      });
      const routingControl = ref(null);

      // Fake data (propri√©t√©s du bien)
      const property = ref({
        id: 1,
        titre: "Appartement Moderne Centre-Ville",
        adresse: "15 Rue de la R√©publique, 69002 Lyon",
        type: "Appartement",
        surface: 85,
        pieces: 3,
        etage: 3,
        charges: 120,
        prix: "345 000",
        description: "Magnifique appartement neuf avec vue d√©gag√©e. Cuisine √©quip√©e moderne, parquet massif, baies vitr√©es. Proche des commodit√©s, transports et √©coles.",
        
        owner: {
          nom: "M. Dupont",
          tel: "+33 6 12 34 56 78"
        },
        
        caracteristiques: [
          "Balcon", "Cuisine √©quip√©e", "Parquet", 
          "Double vitrage", "Cave", "Parking"
        ],
        
        photos: [
          { url: "https://picsum.photos/800/600?random=1", thumb: "https://picsum.photos/100/75?random=1" },
          { url: "https://picsum.photos/800/600?random=2", thumb: "https://picsum.photos/100/75?random=2" },
          { url: "https://picsum.photos/800/600?random=3", thumb: "https://picsum.photos/100/75?random=3" },
          { url: "https://picsum.photos/800/600?random=4", thumb: "https://picsum.photos/100/75?random=4" }
        ],
        
        plan: [
          { id: 1, nom: "Salon", surface: 28, color: "#FF6B35", x: 45.7642, y: 4.8358, rating: 4, comment: "Tr√®s lumineux" },
          { id: 2, nom: "Cuisine", surface: 12, color: "#005E9B", x: 45.7641, y: 4.8360, rating: 5, comment: "√âquip√©e compl√®te" },
          { id: 3, nom: "Chambre 1", surface: 16, color: "#2E8B57", x: 45.7640, y: 4.8356, rating: 3, comment: "Un peu petite" },
          { id: 4, nom: "Chambre 2", surface: 14, color: "#9370DB", x: 45.7639, y: 4.8358, rating: 4, comment: "Vue imprenable" },
          { id: 5, nom: "Salle de bain", surface: 8, color: "#FFA500", x: 45.7643, y: 4.8360, rating: 4, comment: "Bien agenc√©e" },
          { id: 6, nom: "WC", surface: 3, color: "#808080", x: 45.7644, y: 4.8357, rating: 2, comment: "Trop petit" }
        ],
        
        immeuble: {
          nom: "R√©sidence Bellecour",
          adresse: "15 Rue de la R√©publique, 69002 Lyon",
          etages: 8,
          appartements: 32,
          annee: 2015
        },
        
        gestionnaire: {
          nom: "Conciergerie Pro",
          tel: "+33 4 72 12 34 56"
        },
        
        coords: [45.764043, 4.835659]
      });

      const currentPhotoUrl = computed(() => {
        return property.value.photos[currentPhotoIndex.value]?.url || '';
      });

      const setCurrentSlide = (index) => {
        currentSlide.value = index;
        if (typeof $ !== 'undefined' && $('#photoCarousel').length) {
          $('#photoCarousel').carousel(index);
        }
      };

      const openLightbox = (index) => {
        currentPhotoIndex.value = index;
        if (typeof bootstrap !== 'undefined') {
          new bootstrap.Modal(document.getElementById('photoLightbox')).show();
        }
      };

      const toggleView = () => {
        mapView.value = !mapView.value;
        if (mapView.value) {
          showMapView();
        } else {
          showFloorPlanView();
        }
      };

      const locateUser = () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const userPos = [position.coords.latitude, position.coords.longitude];
              if (map.value) {
                map.value.setView(userPos, 16);
                L.marker(userPos, {
                  icon: L.divIcon({
                    className: 'floor-marker',
                    html: '<i class="bi bi-person-fill"></i>',
                    iconSize: [24, 24]
                  })
                }).addTo(map.value).bindPopup("Votre position");
              }
            },
            () => {
              alert("Impossible d'obtenir votre position");
            }
          );
        } else {
          alert("La g√©olocalisation n'est pas support√©e par votre navigateur");
        }
      };

      const toggleLayer = (layerName) => {
        layers.value[layerName] = !layers.value[layerName];
        
        // Nettoyage des couches existantes
        if (infoLayers.value[layerName]) {
          infoLayers.value[layerName].forEach(layer => {
            if (map.value) map.value.removeLayer(layer);
          });
          infoLayers.value[layerName] = [];
        }
        
        if (layers.value[layerName]) {
          loadLayerData(layerName);
        }
      };

      const loadLayerData = (layerName) => {
        // Donn√©es fictives pour les couches
        const layerData = {
          transport: [
            { coords: [45.7645, 4.8350], name: "M√©tro A - Bellecour", type: "m√©tro" },
            { coords: [45.7635, 4.8360], name: "Bus 22 - R√©publique", type: "bus" },
            { coords: [45.7640, 4.8345], name: "Tram T1 - H√¥tel de Ville", type: "tram" }
          ],
          commerces: [
            { coords: [45.7638, 4.8355], name: "Supermarch√© Carrefour", type: "supermarch√©" },
            { coords: [45.7642, 4.8365], name: "Pharmacie Centre", type: "pharmacie" },
            { coords: [45.7635, 4.8350], name: "Boulangerie Paul", type: "boulangerie" }
          ],
          services: [
            { coords: [45.7648, 4.8352], name: "H√¥pital Lyon-Sud", type: "h√¥pital" },
            { coords: [45.7632, 4.8362], name: "Poste Centre", type: "poste" },
            { coords: [45.7645, 4.8340], name: "Biblioth√®que municipale", type: "biblioth√®que" }
          ]
        };

        if (layerData[layerName] && map.value) {
          layerData[layerName].forEach(item => {
            const icon = L.divIcon({
              className: 'floor-marker',
              html: getIconForType(item.type),
              iconSize: [24, 24]
            });
            
            const marker = L.marker(item.coords, { icon: icon })
              .addTo(map.value)
              .bindPopup(`<b>${item.name}</b><br>Type: ${item.type}`);
            
            if (!infoLayers.value[layerName]) infoLayers.value[layerName] = [];
            infoLayers.value[layerName].push(marker);
          });
        }
      };

      const getIconForType = (type) => {
        const icons = {
          m√©tro: '<i class="bi bi-train-front"></i>',
          bus: '<i class="bi bi-bus-front"></i>',
          tram: '<i class="bi bi-train-front"></i>',
          supermarch√©: '<i class="bi bi-cart"></i>',
          pharmacie: '<i class="bi bi-capsule"></i>',
          boulangerie: '<i class="bi bi-cup-straw"></i>',
          h√¥pital: '<i class="bi bi-hospital"></i>',
          poste: '<i class="bi bi-envelope"></i>',
          biblioth√®que: '<i class="bi bi-book"></i>'
        };
        return icons[type] || '<i class="bi bi-geo-alt"></i>';
      };

      const calculateRoute = () => {
        if (!departurePoint.value) {
          alert("Veuillez entrer un point de d√©part");
          return;
        }
        
        // Simulation d'itin√©raire
        alert(`Itin√©raire calcul√© de "${departurePoint.value}" vers "${property.value.adresse}"`);
      };

      const rateRoom = (room) => {
        selectedRoom.value = room;
        newRating.value = room.rating;
        newComment.value = room.comment || '';
        if (typeof bootstrap !== 'undefined') {
          new bootstrap.Modal(document.getElementById('ratingModal')).show();
        }
      };

      const setRating = (rating) => {
        newRating.value = rating;
      };

      const saveRating = () => {
        if (selectedRoom.value) {
          selectedRoom.value.rating = newRating.value;
          selectedRoom.value.comment = newComment.value;
          if (typeof bootstrap !== 'undefined') {
            bootstrap.Modal.getInstance(document.getElementById('ratingModal')).hide();
          }
        }
      };

      // Initialisation de la carte
      const initMap = () => {
        if (typeof L === 'undefined') {
          console.error('Leaflet.js n\'est pas charg√©');
          return;
        }
        
        map.value = L.map('map-container').setView(property.value.coords, 17);
        
        // Tuiles OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap'
        }).addTo(map.value);
        
        // Marqueur du bien
        const propertyMarker = L.marker(property.value.coords).addTo(map.value)
          .bindPopup(`
            <b>${property.value.titre}</b><br>
            ${property.value.adresse}<br>
            <strong>${property.value.prix} ‚Ç¨</strong>
          `)
          .openPopup();
        
        markers.value.push(propertyMarker);
        
        // Contr√¥les personnalis√©s
        if (L.control.fullscreen) {
          L.control.fullscreen().addTo(map.value);
        }
      };

      // Vue carte principale
      const showMapView = () => {
        if (!map.value) return;
        
        // Nettoyage
        if (floorMarkers.value) {
          floorMarkers.value.forEach(m => map.value.removeLayer(m));
          floorMarkers.value = [];
        }
        
        // R√©initialisation
        map.value.setView(property.value.coords, 17);
      };

      // Vue plan d'√©tage
      const showFloorPlanView = () => {
        if (!map.value) return;
        
        // Centrage sur l'immeuble
        map.value.setView(property.value.coords, 18);
        
        // Ajout des marqueurs des pi√®ces
        property.value.plan.forEach(room => {
          const marker = L.marker([room.x, room.y], {
            icon: L.divIcon({
              className: 'floor-marker',
              html: room.id,
              iconSize: [24, 24]
            })
          }).addTo(map.value)
            .bindPopup(`
              <b>${room.nom}</b><br>
              Surface: ${room.surface} m¬≤<br>
              Note: ${room.rating}/5 ‚≠ê<br>
              <small class="text-muted">√âtage ${property.value.etage}</small>
            `);
          
          if (!floorMarkers.value) floorMarkers.value = [];
          floorMarkers.value.push(marker);
        });
      };

      onMounted(() => {
        // V√©rification que Leaflet est charg√©
        if (typeof L !== 'undefined') {
          initMap();
          showMapView();
        } else {
          console.error('Leaflet non charg√© - impossible d\'initialiser la carte');
        }
        
        // Initialisation carousel
        if (typeof $ !== 'undefined' && $('#photoCarousel').length) {
          $('#photoCarousel').carousel({
            interval: false
          });
        }
      });

      return {
        property,
        currentSlide,
        currentPhotoIndex,
        currentPhotoUrl,
        mapView,
        showItinerary,
        departurePoint,
        selectedRoom,
        newRating,
        newComment,
        layers,
        setCurrentSlide,
        openLightbox,
        toggleView,
        locateUser,
        toggleLayer,
        calculateRoute,
        rateRoom,
        setRating,
        saveRating
      };
    }
  });

  app.mount('#app');
});
</script>
</body>
</html>