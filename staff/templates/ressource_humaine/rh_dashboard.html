
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HR Dashboard – Conciergerie</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.css" rel="stylesheet">
  <style>
    :root {
      --clr-indigo: #4f46e5;
      --clr-orange: #f97316;
      --clr-gray: #6b7280;
      --clr-light: #f9fafb;
    }
    body { background: var(--clr-light); }
    .kpi-card { border-left: 4px solid var(--clr-indigo); }
    .fc-event { cursor: pointer; }
    .employee-card:hover { transform: translateY(-2px); transition: .2s; }
  </style>
</head>
<body>
  <div id="app" class="container py-4">
    <!-- top bar -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h4 mb-0">RH Conciergerie</h1>
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-primary" @click="currentTab='overview'">Vue d’ensemble</button>
        <button class="btn btn-sm btn-outline-primary" @click="currentTab='planning'">Planning</button>
        <button class="btn btn-sm btn-outline-primary" @click="currentTab='employees'">Employés</button>
        <button class="btn btn-sm btn-outline-primary" @click="currentTab='leaves'">Congés</button>
      </div>
    </div>

    <!-- KPI row -->
    <div v-if="currentTab==='overview'" class="row g-3 mb-4">
      <div class="col-6 col-md-3" v-for="k in kpis" :key="k.label">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <h6 class="card-subtitle mb-1 text-muted">{{ k.label }}</h6>
            <h4 class="mb-0">{{ k.value }}</h4>
          </div>
        </div>
      </div>
    </div>

    <!-- PLANNING -->
    <div v-if="currentTab==='planning'">
      <div class="card shadow-sm p-3">
        <h5 class="mb-3">Planning du personnel</h5>
        <div id="calendar"></div>
      </div>
    </div>

    <!-- EMPLOYEES -->
    <div v-if="currentTab==='employees'">
      <div class="row g-3">
        <div class="col-md-6 col-lg-4" v-for="emp in employees" :key="emp.id">
          <div class="card employee-card shadow-sm h-100">
            <div class="card-body d-flex align-items-center gap-3">
              <img :src="emp.photo || 'https://ui-avatars.com/api/?name='+emp.user.username" class="rounded-circle" width="48" height="48" alt="">
              <div>
                <h6 class="mb-0">{{ emp.user.first_name }} {{ emp.user.last_name }}</h6>
                <small class="text-muted">{{ emp.role }}</small><br>
                <small :class="emp.is_active ? 'text-success' : 'text-danger'">{{ emp.is_active ? 'Actif' : 'Inactif' }}</small>
              </div>
            </div>
            <div class="card-footer bg-transparent">
              <button class="btn btn-sm btn-primary" @click="selectEmployee(emp)">Voir fiche</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LEAVES -->
    <div v-if="currentTab==='leaves'">
      <div class="card shadow-sm p-3">
        <h5 class="mb-3">Demandes de congés</h5>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Employé</th><th>Début</th><th>Fin</th><th>Type</th><th>Statut</th><th></th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="l in leaves" :key="l.id">
                <td>{{ l.employee.user.first_name }} {{ l.employee.user.last_name }}</td>
                <td>{{ l.start_date }}</td>
                <td>{{ l.end_date }}</td>
                <td>{{ l.get_type_absence_display }}</td>
                <td><span :class="badgeClass(l)">{{ l.get_type_absence_display }}</span></td>
                <td>
                  <button v-if="l.type_absence==='NJSU'" class="btn btn-sm btn-success" @click="approveLeave(l)">Approuver</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CHARTS -->
    <div v-if="currentTab==='overview'" class="row mt-4">
      <div class="col-md-6">
        <div class="card shadow-sm p-3">
          <canvas id="staffOccChart"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm p-3">
          <canvas id="delayChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
      setup() {
        const currentTab = ref('overview');
        const kpis       = ref([]);
        const employees  = ref([]);
        const leaves     = ref([]);
        let calendar     = null;

        /* ---------- Axios defaults ---------- */
        axios.defaults.headers.common['Authorization'] = `Bearer ${localStorage.getItem('access') || ''}`;

        /* ---------- helpers ---------- */
        const agencyFilter = () => ({ agency: window.AGENCY_ID || 1 }); // injectée côté Django si besoin

        /* ---------- API ---------- */
        const loadKPIs = async () => {
          const params = agencyFilter();
          const [occ, late, pending, csat] = await Promise.all([
            axios.get('/api/kpi/acceptance/', { params }).then(r => r.data.acceptance_rate),
            axios.get('/api/tasks/', { params: { ...params, completed: false } }).then(r => r.data.count),
            axios.get('/api/absences/', { params: { ...params, status: 'NJSU' } }).then(r => r.data.count),
            axios.get('/api/kpi/csat/', { params }).then(r => r.data.csat)
          ]);
          kpis.value = [
            { label: 'Taux présence', value: `${occ}%` },
            { label: 'Tâches en retard', value: late },
            { label: 'Congés en attente', value: pending },
            { label: 'CSAT moyen', value: `${csat}/5` }
          ];
        };

        const loadEmployees = async () => {
          const { data } = await axios.get('/api/employees/', { params: agencyFilter() });
          employees.value = data;
        };

        const loadLeaves = async () => {
          const { data } = await axios.get('/api/absences/', { params: agencyFilter() });
          leaves.value = data;
        };

        const initCalendar = () => {
          calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'timeGridWeek',
            height: 500,
            events: '/api/tasks/',
            extraParams: agencyFilter()
          });
          calendar.render();
        };

        const initCharts = () => {
          new Chart(document.getElementById('staffOccChart'), {
            type: 'doughnut',
            data: {
              labels: ['Occupé', 'Disponible'],
              datasets: [{
                data: [70, 30],
                backgroundColor: ['#4f46e5', '#e5e7eb']
              }]
            }
          });
          new Chart(document.getElementById('delayChart'), {
            type: 'line',
            data: {
              labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
              datasets: [{
                label: 'Retards',
                data: [2, 1, 3, 0, 2, 1, 1],
                borderColor: '#f97316',
                tension: 0.3
              }]
            }
          });
        };

        const approveLeave = async (leave) => {
          await axios.patch(`/api/absences/${leave.id}/`, { type_absence: 'CONG' });
          await loadLeaves();
        };

        const badgeClass = (l) => l.type_absence === 'CONG' ? 'badge bg-success' : 'badge bg-warning';

        /* ---------- life-cycle ---------- */
        onMounted(async () => {
          await Promise.all([loadKPIs(), loadEmployees(), loadLeaves()]);
          if (currentTab.value === 'planning') initCalendar();
          if (currentTab.value === 'overview') initCharts();
          feather.replace();
        });

        return {
          currentTab, kpis, employees, leaves, approveLeave, badgeClass
        };
      }
    }).mount('#app');
  </script>

  <!-- README -->
  <div class="container mt-5 small text-muted">
    <hr>
    <h6>README – Integration</h6>
    <ol>
      <li>Ensure Django serves the 4 endpoints listed in section 5 (or adapt URLs in script).</li>
      <li>Inject <code>window.AGENCY_ID = {{ user.employee.agency.id }};</code> in template if you want automatic agency scoping.</li>
      <li>Put the file in your <code>templates/</code> folder and render it with a simple TemplateView.</li>
      <li>No build step – everything is CDN.</li>
    </ol>
  </div>
</body>
</html>