
{% extends "property_detail.html" %}
{% load  static %}


{% block revenue_report %}
    <div>
        <h4>Rapport de revenus</h4>
        <table class="table table-hover table-striped">
            <thead>
                <tr class="bg-info"> <th>Mois / Année</th> <th>Revenu</th> </tr>
            </thead>
            <tbody>
                <tr v-for="item in revenueData">
                    <td>[[ item.month ]]</td>
                    <td>[[ item.revenue ]]</td>
                </tr>
            </tbody>
        </table>
    </div>
{% endblock revenue_report%}

{% block taux_occupation %}
    <div id="occupation-report">
        <h4>Taux occupation</h4>
        <table class="table table-hover table-striped">
            <thead>
                <tr class="bg-info">
                    <th>Mois / Année</th>
                    <th>Taux occupation</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="item in tauxData">
                    <td>[[ item.month ]]</td>
                    <td>[[ item.occupancy_rate ]] %</td>
                </tr>
            </tbody>
        </table>
    </div>
{% endblock taux_occupation %}

{% block evolution %}
    <div class="col-md-6 mb-3">
        <h3 class="card-header">Évolution des revenus des réservations</h3>
        <div class="card">
            <div class="card-body">
                <div id="chartAreaBar"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <h3 class="card-header">Évolution des prix par mois de la property </h3>
         <div class="card">
            <div class="card-body">
                <div id="chartAreaLine"></div>
            </div>
        </div>
    </div>
{% endblock evolution %}

{% block extra_css%}
    <link href="{% static 'css/mychart_style.css' %}" rel="stylesheet">
{% endblock extra_css%}

{% block extra_js %}
<script> 
    const myConsole = new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            message : "Vue.js",
            revenueData: {},
            pricesData: {},
            tauxData: {},
            dataset: [],
            revenus: [],
            prices: [],
            months: [],
            chartData : [
                {"date": "2023-01", "revenue": 1000},
                {"date": "2023-02", "revenue": 1200},
                {"date": "2023-03", "revenue": 1100},
                {"date": "2023-04", "revenue": 1300},
                {"date": "2023-05", "revenue": 1500},
            ],
        },
        mounted() {
            this.fetchRevenueData();
            this.fetchMonthlyPriceData();
            this.fetchTauxOccupData();
            //--------------
        },
        updated(){
            this.renderChartEvolutionPrice("#chartAreaBar", this.months, this.revenus, "Revenues par mois");
            this.renderChartEvolutionPrice("#chartAreaLine", this.months, this.prices, "Evolutions des prix par mois");
            //this.renderChartLine();
        },
        methods: {
            async fetchMonthlyPriceData(){
                let url = `{% url "report:api_property_price_evolution" property.pk  %}`
                await fetch(url)
                    .then(response => response.json())
                    .then(response => {
                        this.pricesData = response.dataset;
                        //- 
                        this.prices = this.pricesData.map(elem => parseFloat(elem.price))
                        this.months = this.pricesData.map(item => String(item.month)); // Supposons que chaque élément a une propriété 'month'
                        //console.log("this.prices = ####", this.prices)
                        //console.log("this.months = ####", this.months)
                    })
                    .catch(err => {
                        console.log("err axios :",  err)
                    });
            },
            async fetchRevenueData(){
                let url = `{% url "report:api_property_revenue_by_month"  property.pk  %}`
                await fetch(url)
                    .then(response => response.json())
                    .then(json => {
                        this.revenueData = json.dataset;
                        this.revenueData.map(elem => parseFloat(elem.revenue))
                        //- 
                        this.revenus = this.revenueData.map(elem => parseFloat(elem.revenue))
                        this.months = this.revenueData.map(item => item.month); // Supposons que chaque élément a une propriété 'month'
                        console.log("datset= revenue", this.revenueData)
                       
                    });
            },
            // taux occupation
            async fetchTauxOccupData() {
                let url = `{% url "report:api_property_occupancy_rate_by_month" property.pk  %}`
                fetch(url)
                    .then(response => response.json())
                    .then(json => {
                        this.tauxData = json.dataset;
                        console.log("datset taux occup=", this.tauxData)
                    });
            },
            //---------
            // RENDER EN ligne
            renderChartLine(){
                if (!this.revenueData || this.revenueData.length === 0) {
                    console.error("Pas de données à afficher");
                    return;
                }

                let data = this.revenueData.map((item, index) => ({
                    month: item.month,
                    revenue: this.revenus[index]
                }));

                // Dimensions et marges
                const margin = {top: 20, right: 30, bottom: 50, left: 60};
                const width = 600 - margin.left - margin.right;
                const height = 400 - margin.top - margin.bottom;

                // Création du SVG
                const svg = d3.select('#chartAreaLine').append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom)
                    .append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                // Échelles
                const x = d3.scalePoint()
                    .domain(data.map(d => d.month))
                    .range([0, width]);

                const y = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.revenue)])
                    .range([height, 0]);

                // Ligne
                const line = d3.line()
                    .x(d => x(d.month))
                    .y(d => y(d.revenue));

                // Ajout de la ligne au graphique
                svg.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 1.5)
                    .attr("d", line);

                // Ajout des points
                svg.selectAll(".dot")
                    .data(data)
                    .enter().append("circle")
                    .attr("class", "dot")
                    .attr("cx", d => x(d.month))
                    .attr("cy", d => y(d.revenue))
                    .attr("r", 5)
                    .attr("fill", "steelblue");

                // Axe X
                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x))
                    .selectAll("text")  
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-45)");

                // Axe Y
                svg.append("g")
                    .call(d3.axisLeft(y));

                // Étiquettes des axes
                svg.append("text")
                    .attr("transform", `translate(${width/2}, ${height + margin.top + 20})`)
                    .style("text-anchor", "middle")
                    .text("Mois");

                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .text("Revenus");

                // Ajout des valeurs sur les points
                svg.selectAll(".value-label")
                    .data(data)
                    .enter().append("text")
                    .attr("class", "value-label")
                    .attr("x", d => x(d.month))
                    .attr("y", d => y(d.revenue) - 10)
                    .attr("text-anchor", "middle")
                    .text(d => d.revenue);
            },

          
            renderChartEvolutionPrice(id_area='#chartAreaBar', data_x=[], data_y=[], title="" ) {
                if (!this.revenueData || this.revenueData.length === 0) {
                    console.error("Pas de données à afficher");
                    return;
                }

                let data_prices = data_y
                let data_months = data_x

                // Initialization
                const svgWidth = 450; // Augmenté pour plus d'espace
                const svgHeight = 400; // Augmenté pour plus d'espace
                const margin = { top: 50, right: 30, bottom: 60, left: 40 }; // Ajusté pour l'axe X
                const chartWidth = svgWidth - margin.left - margin.right;
                const chartHeight = svgHeight - margin.top - margin.bottom;

                // SVG initialization
                d3.select(id_area).selectAll('*').remove(); // Nettoyer le contenu existant
                const svg = d3.select(id_area).append('svg')
                    .attr('width', svgWidth)
                    .attr('height', svgHeight)
                    .append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                // Échelles
                const xScale = d3.scaleBand()
                    .domain(data_months)
                    .range([0, chartWidth])
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(data_prices)])
                    .range([chartHeight, 0]);

                // Axes
                const xAxis = d3.axisBottom(xScale);
                const yAxis = d3.axisLeft(yScale);

                // Ajout de l'axe X
                svg.append("g")
                    .attr("transform", `translate(0,${chartHeight})`)
                    .call(xAxis)
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-45)");

                // Ajout de l'axe Y
                svg.append("g")
                    .call(yAxis);

                // Création des barres
                const bars = svg.selectAll('.bar')
                    .data(data_prices)
                    .enter()
                    .append('g')
                    .attr('class', 'bar');

                bars.append('rect')
                    .attr("x", (d, i) => xScale(data_months[i]))
                    .attr("y", d => yScale(d))
                    .attr("width", xScale.bandwidth())
                    .attr("height", d => chartHeight - yScale(d))
                    .attr("fill", "steelblue");

                // Ajout des textes sur les barres
                bars.append("text")
                    .attr("class", "text-info")
                    .style("font-size", "16px")
                    .attr("x", (d, i) => xScale(data_months[i]) + xScale.bandwidth() / 2)
                    .attr("y", d => yScale(d) - 5)
                    .attr("text-anchor", "middle")
                    .text(d => d);

                // Ajout du titre du graphique
                svg.append("text")
                    .attr("x", chartWidth / 2)
                    .attr("y", 0 - (margin.top / 2))
                    .attr("text-anchor", "middle")
                    .style("font-size", "16px")
                    .attr("class", "text-info")
                    .style("text-decoration", "underline")
                    .text(title)
            },

        }
    });
</script>
{% endblock %}


