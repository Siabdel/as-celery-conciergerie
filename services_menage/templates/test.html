
<script>
    let this.chartData = d3.range(10).map(el=> Math.floor(Math.random() * 100))

    const myConsole = new Vue({
    el:'#debug',
    data:{
        status:'idle',
        datasize:10,
        selected:-1
    },
    methods:{
        datarefresh(){
        this.chartData = d3.range(this.datasize).map(el=>
        Math.floor(Math.random() * 100))
        this.this.chartData = this.chartData
        this.$forceUpdate() // this is necessary because it's array
        render()
        }
    },
    template:`
    <div>
        <p>try <b>click</b> or <b>put your cursor</b> over elements</p>
        <input type="range" min="5" max="30" v-model="datasize" @change="datarefresh">
        <p><b>datasize :</b> {{datasize}} (manipulate the bar above to adjust size)</p>
        <p><b>status :</b> {{status}}</p>
    </div>
    `
    })

    const svgWidth = 800
    const svgHeight = 400
    const margin = 50
    const barMargin = 10
    const chartWidth = svgWidth - margin * 2
    const chartHeight = svgHeight - margin * 2

    //initialization
    const svg = d3.select('#chartArea').append('svg')

    svg.attr('width',svgWidth)
        .attr('height',svgHeight)
        .append('g')
        .attr('class','axis')
        .attr('transform',`translate(${25},${margin})`)

    render()


    //////////////// rendering
    function render(){

    const bars = svg.selectAll('.bar').data(this.chartData)
    .enter()
    .append('g')
    .attr('class','bar')
    .on('mouseover',function(d,i){
        d3.select(this).classed('bar-selected',true)
        myConsole.status = `index:${i}, value:${d}`
        if(myConsole.selected > -1) myConsole.status += ', selected:' + myConsole.selected
    })
    .on('mouseout',function(d){
        d3.select(this).classed('bar-selected',false)
        myConsole.status = myConsole.selected > -1 ? 'selected:' + myConsole.selected : 'idle'
    })
    .on('click',function(d,i){
        alert('clicked index:' + i)
        myConsole.selected = i
        d3.selectAll('.bar').classed('bar-clicked',false)
        d3.select(this).classed('bar-clicked',true)
    })
    
    bars.append('rect')
    bars.append('text')
    
    const barScaleX = d3.scaleLinear()
    .domain([0,this.chartData.length])
    .range([0 ,chartWidth])
    
    const barScaleY = d3.scaleLinear()
    .domain([0,Math.max(...this.chartData)])
    .range([0,chartHeight])
    
    const barWidth = ((chartWidth - margin * 2) / this.chartData.length) - barMargin
    
    const fontScale = d3.scaleLinear()
    .domain([0,30])
    .range(['60px','11px'])
    
    //update bars
    svg.selectAll('.bar').data(this.chartData).select('rect')
    .transition()
    .attr('x',function(d,i){ return barScaleX(i)})
    .attr('y',function(d,i){ return chartHeight - barScaleY(d) })
    .attr('width',function(d,i){ return barWidth})
    .attr('height',function(d,i){ return barScaleY(d) })
    .attr('transform',`translate(${30},${margin})`)
    
        //update texts
    svg.selectAll('.bar').data(this.chartData).select('text')
    .transition()
    .attr('x', function(d,i){ return barScaleX(i)})
    .attr('y', function(d,i){ return chartHeight - barScaleY(d)})
    .attr('font-size',function(d,i){ return fontScale(myConsole.datasize)})
    .text(function(d){ return d})
    .attr('transform',`translate(${30},${margin})`)
    
    //update axis
    const scaleAxisY = d3.scaleLinear()
    .domain([0,Math.max(...this.chartData)])
    .range([chartHeight,0])
    const axisY = d3.axisLeft().scale(scaleAxisY)
    svg.select('g.axis')
        .transition()
        .call(axisY)
    
    svg.selectAll('.bar').data(this.chartData)
    .exit()
    .remove()
    }
</script>