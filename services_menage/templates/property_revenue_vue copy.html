
{% extends "property_detail.html" %}
{% load  static %}


{% block revenue_report %}
<div>
    <h4>Rapport de revenus</h4>
    <table class="table table-hover table-striped">
        <thead>
            <tr class="bg-info">
                <th>Mois / Année</th>
                <th>Revenu</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="item in revenueData">
                <td>[[ item.month ]]</td>
                <td>[[ item.revenue ]]</td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock revenue_report%}

{% block taux_occupation %}
<div id="occupation-report">
    <h4>Taux occupation</h4>
    <table class="table table-hover table-striped">
        <thead>
            <tr class="bg-info">
                <th>Mois / Année</th>
                <th>Taux occupation</th>
            </tr>
        </thead>
        <tbody>
            <tr v-for="item in tauxData">
                <td>[[ item.month ]]</td>
                <td>[[ item.occupancy_rate ]] %</td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock taux_occupation %}

{% block evolution %}
<!-- ---------------------------- -->
<div class="container">
    <h3 class="card-header">Évolution des revenus des réservations</h3>
    <div class="card">
        <div class="card-body">
            [[ message ]]
            <div id="chartArea"></div>
        <div>
    </div
</div>
{% endblock evolution %}

{% block extra_css%}
    <link href="{% static 'css/mychart_style.css' %}" rel="stylesheet">
{% endblock extra_css%}

{% block extra_js %}
{{ block.super }}
<script> 
    const myConsole = new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            message : "Ici c'est Vue.js",
            revenueData: {},
            tauxData: {},
            dataset: [],
            ChartData : [
                {"date": "2023-01", "revenue": 1000},
                {"date": "2023-02", "revenue": 1200},
                {"date": "2023-03", "revenue": 1100},
                {"date": "2023-04", "revenue": 1300},
                {"date": "2023-05", "revenue": 1500},
            ],
        },
        mounted(){
            //--------------
            this.loadData();
        },
        methods: {
             // Fonction pour charger les données de l'API
         
            // taux occupation
            async fetchTauxOccupData() {
                let url = `{% url "report:api_property_occupancy_rate_by_month" property.pk  %}`
                await fetch(url)
                    .then(response => response.json())
                    .then(json => {
                        this.tauxData = json.dataset;
                        console.log("datset taux occup=", this.tauxData)
                    });
            },
            //---------
            async fetchRevenueChart(){ 
                //initialization
                const svgWidth = 400
                const svgHeight = 350
                const margin = 50
                const barMargin = 10
                const chartWidth = svgWidth - margin * 2
                const chartHeight = svgHeight - margin * 2

                //initialization
                const svg = d3.select('#chartArea').append('svg')

                svg.attr('width',svgWidth)
                    .attr('height',svgHeight)
                    .append('g')
                    .attr('class','axis')
                    .attr('transform',`translate(${25},${margin})`)
                
                //////////////// rendering
                const bars = svg.selectAll('.bar').data(this.chartdata)
                    .enter()
                    .append('g')
                    .attr('class','bar')
                    .on('mouseover',function(d,i){
                        d3.select(this).classed('bar-selected',true)
                        myConsole.status = `index:${i}, value:${d}`
                        if(myConsole.selected > -1) myConsole.status += ', selected:' + myConsole.selected
                    })
                    .on('mouseout',function(d){
                        d3.select(this).classed('bar-selected',false)
                        myConsole.status = myConsole.selected > -1 ? 'selected:' + myConsole.selected : 'idle'
                    })
                    .on('click',function(d,i){
                        alert('clicked index:' + i)
                        myConsole.selected = i
                        d3.selectAll('.bar').classed('bar-clicked',false)
                        d3.select(this).classed('bar-clicked',true)
                    })
                
                bars.append('rect')
                bars.append('text')
                
                const barScaleX = d3.scaleLinear()
                .domain([0,this.chartdata.length])
                .range([0 ,chartWidth])
                
                const barScaleY = d3.scaleLinear()
                .domain([0,Math.max(...this.chartdata)])
                .range([0,chartHeight])
                
                const barWidth = ((chartWidth - margin * 2) / this.chartdata.length) - barMargin
                
                const fontScale = d3.scaleLinear()
                .domain([0,30])
                .range(['60px','11px'])
                
                //update bars
                svg.selectAll('.bar').data(this.chartdata).select('rect')
                .transition()
                .attr('x',function(d.date,i){ return barScaleX(i)})
                .attr('y',function(d.revenue,i){ return chartHeight - barScaleY(d) })
                .attr('width',function(d,i){ return barWidth})
                .attr('height',function(d,i){ return barScaleY(d) })
                .attr('transform',`translate(${30},${margin})`)
                
                    //update texts
                svg.selectAll('.bar').data(this.chartdata).select('text')
                .transition()
                .attr('x', function(d,i){ return barScaleX(i)})
                .attr('y', function(d,i){ return chartHeight - barScaleY(d)})
                .attr('font-size',function(d,i){ return fontScale(myConsole.datasize)})
                .text(function(d){ return d})
                .attr('transform',`translate(${30},${margin})`)
                
                //update axis
                const scaleAxisY = d3.scaleLinear()
                .domain([0,Math.max(...this.chartdata)])
                .range([chartHeight,0])
                const axisY = d3.axisLeft().scale(scaleAxisY)
                svg.select('g.axis')
                    .transition()
                    .call(axisY)
                
                svg.selectAll('.bar').data(this.chartdata)
                .exit()
                .remove()
            },
        }
    });
</script>
{% endblock %}


