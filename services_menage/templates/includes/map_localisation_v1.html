{% load i18n static %}

<div class="section mt-4">
  <div class="card" id="localisation">
    <div class="card-header text-left">
      <label class="text-info fa-2x p-2">Localisation coordonnees</label>
      Latitude, Longitude : {{ property.latitude|default:"30.42630512273604" }},
      {{ property.longitude|default:"-9.583120561837177" }}
    </div>

    <div class="card-body">
      <div id="property-map" style="width: 100%; height: 400px; border-radius: 8px; overflow: hidden" ></div>
    </div>
  </div>
</div>

<!-- Leaflet CSS -->
{% block extra_css %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Données de la propriété depuis Django
      const propertyData = {
          id: {{ property.id|default:1 }},
          title: "{{ property.title|escapejs }}",
          location: "{{ property.location|escapejs }}",
          latitude: parseFloat("{{ property.latitude|default:'30.42630512273604' }}".replace(',', '.')),
          longitude: parseFloat("{{ property.longitude|default:'-9.583120561837177' }}".replace(',', '.'))
      };

      // Initialiser la carte Leaflet
      if (typeof L !== 'undefined') {
          // Créer la carte centrée sur les coordonnées de la propriété
          const map = L.map('property-map').setView([propertyData.latitude, propertyData.longitude], 15);
          console.log("Map initialized at: ", propertyData.latitude, propertyData.longitude);

          // Ajouter les tuiles OpenStreetMap
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);

          // Ajouter un marqueur avec popup
          const popupContent = ` <div> <strong>${propertyData.title}</strong> <br>${propertyData.location} </div> `;

          L.marker([propertyData.latitude, propertyData.longitude]).addTo(map)
              .bindPopup(popupContent)
              .openPopup();
      }
  });
</script>
